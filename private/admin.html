<!doctype html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin Panel - Loglar</title>
  <style>
*{box-sizing:border-box}

body{
  font-family:Arial,sans-serif;
  margin:0;
  background:#f3f4f6;
  color:#111827;
}

/* ---------------- HEADER ---------------- */

header{
  background:#0f172a;
  color:#fff;
  padding:14px 16px;
  position:sticky;
  top:0;
  z-index:10;
}

header .wrap{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

header a{
  padding:8px 12px;
  background:#2563eb;
  border-radius:10px;
  color:#fff;
  text-decoration:none;
  font-size:14px;
}

/* ---------------- LAYOUT ---------------- */

.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:16px;
}

/* ---------------- CONTROLS ---------------- */

.controls{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
  margin-bottom:14px;
}

.controls input,
.controls select,
.controls button{
  padding:11px 12px;
  font-size:15px;
  border-radius:10px;
  border:1px solid #d1d5db;
}

.controls button{
  background:#2563eb;
  color:#fff;
  border:none;
  font-weight:600;
}

/* desktop */
@media(min-width:640px){
  .controls{
    grid-template-columns:2fr 1fr auto auto auto;
    align-items:center;
  }
}

/* ---------------- GRID ---------------- */

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:14px;
}

/* ---------------- CARD ---------------- */

.card{
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 4px 14px rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
}

.img{
  width:100%;
  aspect-ratio:4/3;
  object-fit:cover;
  background:#000;
}

.p{
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:4px;
}

.name{
  font-weight:700;
  font-size:16px;
}

.meta{
  font-size:13px;
  color:#374151;
}

.small{
  opacity:.7;
  font-size:13px;
  margin-bottom:10px;
}

/* ---------------- TAGS ---------------- */

.tag{
  align-self:flex-start;
  margin-top:6px;
  padding:5px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}

.ok{background:#dcfce7;color:#166534}
.rej{background:#fee2e2;color:#991b1b}
.lim{background:#fff7ed;color:#9a3412}

/* ---------------- NOTE ---------------- */

.note{
  margin-top:8px;
  padding:8px 10px;
  border-radius:10px;
  background:#f9fafb;
  border:1px dashed #d1d5db;
  font-size:13px;
}

/* ---------------- MOBILE OPTIMIZATION ---------------- */

@media(max-width:480px){
  header .wrap{
    flex-direction:column;
    align-items:flex-start;
  }

  .controls{
    grid-template-columns:1fr;
  }

  .grid{
    grid-template-columns:1fr;
  }
}
</style>

</head>
<body>
<header>
  <div class="wrap">
    <b>Admin Panel</b> — şəkilli loglar
    <a href="/admin/isciler" style="padding:8px 10px;background:#374151;border-radius:10px;color:#fff;text-decoration:none">
  İşçilər
</a>

  </div>
</header>

<div class="wrap">
  <div class="controls">
    <input id="q" placeholder="Ad/Soyad/Vəzifə axtar..." />
    <select id="status">
      <option value="">Hamısı</option>
      <option value="OK">OK</option>
      <option value="REJECT">REJECT</option>
      <option value="LIMIT">LIMIT</option>
    </select>
    <button id="btn">Yenilə</button>
    <input id="ay" type="month" />
<button id="maasExcel">Maaş Excel</button>

  </div>

  <div id="info" class="small"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
  const grid = document.getElementById("grid");
  const info = document.getElementById("info");
  const q = document.getElementById("q");
  const statusSel = document.getElementById("status");
  const btn = document.getElementById("btn");

  function tagClass(st){
    if(st === "OK") return "tag ok";
    if(st === "REJECT") return "tag rej";
    if(st === "LIMIT") return "tag lim";
    return "tag";
  }

  function fmtDate(iso){
    // backend UTC göndərə bilər, sadə göstərəcəyik
    const d = new Date(iso);
    return d.toLocaleString();
  }

  async function load(){
    grid.innerHTML = "";
    info.textContent = "Yüklənir...";

    const r = await fetch("/api/admin/loglar");
    const rows = await r.json();

    const text = q.value.trim().toLowerCase();
    const st = statusSel.value;

    const filtered = rows.filter(x => {
      const blob = `${x.ad||""} ${x.soyad||""} ${x.vezife||""} ${x.mekan||""} ${x.hadise||""}`.toLowerCase();
      const okText = !text || blob.includes(text);
      const okSt = !st || x.status === st;
      return okText && okSt;
    });

    info.textContent = `Göstərilir: ${filtered.length} / ${rows.length}`;

    for(const x of filtered){
      const imgUrl = x.kamera_sekil_url?.startsWith("/") ? x.kamera_sekil_url : "/" + x.kamera_sekil_url;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img class="img" src="${imgUrl}" alt="sekil" />
        <div class="p">
          <p class="name">${(x.ad||"-")} ${(x.soyad||"")}</p>
          <p class="meta"><b>Vəzifə:</b> ${x.vezife || "-"}</p>
          <p class="meta"><b>Məkan:</b> ${x.mekan || "-"}</p>
          <p class="meta"><b>Hadisə:</b> ${x.hadise || "-"}</p>
          <p class="meta"><b>Tarix:</b> ${fmtDate(x.tarix_saat)}</p>
          <span class="${tagClass(x.status)}">${x.status}</span>
           ${x.qeyd ? `<div class="note"><b>Qeyd:</b> ${x.qeyd}</div>` : ``}
        </div>
      `;
      grid.appendChild(card);
    }
  }

  btn.addEventListener("click", load);
  q.addEventListener("input", () => { clearTimeout(window._t); window._t=setTimeout(load, 250); });
  statusSel.addEventListener("change", load);

  load();

  document.getElementById("maasExcel").addEventListener("click", () => {
  const m = document.getElementById("ay").value; // YYYY-MM
  if (!m) return alert("Ay seç: məsələn 2026-02");
  window.location.href = `/api/admin/maas.xlsx?month=${encodeURIComponent(m)}`;
});

</script>
</body>
</html>
