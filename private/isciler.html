<!doctype html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin - İşçilər</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <style>
    :root{
      --bg:#f3f4f6;
      --dark:#111827;
      --dark2:#374151;
      --border:#e5e7eb;
      --muted:#6b7280;
      --card:#ffffff;
      --danger:#b00020;
      --ok:#0a7b2e;
    }

    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:#111827}
    a{color:#fff;text-decoration:none}

    /* HEADER */
    header{
      background:var(--dark);
      color:#fff;
      padding:14px 16px;
      position:sticky;
      top:0;
      z-index:10;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }

    .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }

    .basliq-blok{display:flex;flex-direction:column;gap:4px}
    .basliq-blok b{font-size:18px;line-height:1.1}
    .basliq-blok .mini{font-size:12px;opacity:.85;line-height:1.35}

    .header-actions{display:flex;gap:10px;flex-wrap:wrap}
    .header-actions a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      background:var(--dark2);
      border-radius:12px;
      font-size:14px;
      line-height:1;
      white-space:nowrap;
    }

    /* BOX */
    .box{
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }

    h3{margin:0 0 10px}
    .mini{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok);font-weight:700}
    .bad{color:var(--danger);font-weight:700}

    /* FORM */
    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 220px 140px;
      gap:10px;
      align-items:center;
    }

    input,select,button{
      padding:10px 12px;
      font-size:14px;
      border:1px solid #d1d5db;
      border-radius:10px;
      outline:none;
    }

    input,select{background:#fff}
    button{cursor:pointer;background:var(--dark);color:#fff;border:none}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* TABLE SCROLL (mobil-də sağa daşmasın) */
    .table-wrap{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:auto;              /* scroll burada olacaq */
      background:#fff;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:980px;            /* mobil-də sütunlar sıxılmasın */
    }

    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-size:14px;
      vertical-align:middle;
      white-space:nowrap;
    }

    th{background:#f9fafb;position:sticky;top:0}

    .tag{
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      background:#eef2ff;
      display:inline-block;
    }

    .img{
      width:56px;height:56px;border-radius:10px;object-fit:cover;background:var(--border);
      display:block;
    }

    .btn2{background:var(--dark2)}
    .delBtn{
      background:var(--danger);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:9px 12px;
      font-weight:700;
      cursor:pointer;
    }

    /* Mobile */
    @media (max-width:640px){
      header{padding:12px 12px}
      .wrap{padding:12px}
      .top{flex-direction:column;align-items:flex-start}
      .header-actions{width:100%}
      .header-actions a{width:100%}

      .box{padding:12px}
      .form-grid{grid-template-columns:1fr}
    }

    /* çox balaca ekranlarda bir az sıxlıq */
    @media (max-width:420px){
      th,td{padding:8px;font-size:13px}
      .img{width:44px;height:44px}
      input[type="file"]{max-width:160px}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="basliq-blok">
      <b>İşçilər</b>
      <div class="mini">Referans şəkil (üz yoxlama üçün) buradan yüklənir</div>
    </div>
    <div class="header-actions">
      <a href="/admin">← Loglar</a>
      <a href="/admin/maas">Maaş Tarifləri</a>
      <a href="/admin/telegram">Telegram</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="box">
    <h3>Yeni işçi əlavə et</h3>

    <div class="form-grid">
      <input id="ad" placeholder="Ad" />
      <input id="soyad" placeholder="Soyad" />

      <select id="vezife">
        <option value="">Vəzifə seç</option>
        <option value="kassır">kassır</option>
        <option value="satıcı">satıcı</option>
        <option value="menecer">menecer</option>
      </select>

      <button id="add" type="button">Əlavə et</button>
    </div>

    <div id="msg" style="margin-top:10px"></div>

    <h3 style="margin:16px 0 6px">Siyahı</h3>
    <div class="mini">Qaydası: hər işçiyə 1 referans şəkil yüklə. Sonra QR girişdə üz uyğunluğu yoxlanacaq.</div>
    <div class="mini" style="margin-top:6px">Mobil-də sağa sürüşdürmək üçün: cədvəli sola-sağa sürüşdür.</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Ad</th>
            <th>Soyad</th>
            <th>Vəzifə</th>
            <th>Aktiv</th>
            <th>Referans</th>
            <th>Referans yüklə</th>
            <th>Yaradıldı</th>
            <th>Sil</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- face-api (browser) -->
<script src="/face-api.min.js"></script>

<script>
  const tbody = document.getElementById("tbody");
  const msg = document.getElementById("msg");

  function show(text, ok = true) {
    msg.innerHTML = `<span class="${ok ? "ok" : "bad"}">${text}</span>`;
  }

  function fmtDate(x) {
    if (!x) return "-";
    return new Date(x).toLocaleString();
  }

  // ✅ Basic Auth (Admin)
  const ADMIN_USER = "admin";
  const ADMIN_PASS = "12345";
  const ADMIN_TOKEN = btoa(`${ADMIN_USER}:${ADMIN_PASS}`);

  function authHeaders(extra = {}) {
    return {
      ...extra,
      Authorization: `Basic ${ADMIN_TOKEN}`,
    };
  }

  // ---------- Face models ----------
  let modelsReady = false;

  async function loadModels() {
    await faceapi.nets.ssdMobilenetv1.loadFromUri("/models");
    await faceapi.nets.faceLandmark68Net.loadFromUri("/models");
    await faceapi.nets.faceRecognitionNet.loadFromUri("/models");
    modelsReady = true;
    console.log("✅ Admin: modellər yükləndi");
  }

  function waitImgLoad(imgEl) {
    return new Promise((resolve, reject) => {
      if (imgEl.complete && imgEl.naturalWidth > 0) return resolve();
      imgEl.onload = () => resolve();
      imgEl.onerror = (e) => reject(e);
    });
  }

  window.addEventListener("load", () => {
    loadModels().catch((err) => {
      console.error(err);
      show("Model yükləmə xətası (Console-a bax)", false);
    });
  });

  // ---------- API ----------
  async function load() {
    try {
      tbody.innerHTML = "";

      const r = await fetch("/api/admin/isciler", {
        headers: authHeaders(),
      });

      if (!r.ok) {
        const t = await r.text();
        show("İşçilər yüklənmədi: " + r.status + " " + t, false);
        return;
      }

      const rows = await r.json();
      if (!Array.isArray(rows)) {
        show("Gözlənilməz cavab gəldi (Array deyil). Console-a bax.", false);
        console.log("isciler response:", rows);
        return;
      }

      for (const x of rows) {
        const tr = document.createElement("tr");

        const imgUrl = x.ref_sekil_url ? x.ref_sekil_url : (x.profil_sekil_url || "");
        const yar = fmtDate(x.yaradildi);

        tr.innerHTML = `
          <td>${x.id}</td>
          <td>${x.ad}</td>
          <td>${x.soyad}</td>
          <td>${x.vezife}</td>
          <td><span class="tag">${x.aktiv ? "aktiv" : "deaktiv"}</span></td>

          <td>
            <img class="img" id="img_${x.id}" src="${imgUrl || ""}" alt="ref" style="${imgUrl ? "" : "display:none"}">
          </td>

          <td>
            <input type="file" accept="image/*" id="f_${x.id}" />
            <button class="btn2" type="button" id="u_${x.id}">Yadda saxla</button>
            <div class="mini" id="st_${x.id}"></div>
          </td>

          <td>${yar}</td>

          <td>
            <button class="delBtn" type="button" id="del_${x.id}">Sil</button>
          </td>
        `;

        tbody.appendChild(tr);

        const btn = tr.querySelector(`#u_${x.id}`);
        const fileInput = tr.querySelector(`#f_${x.id}`);
        const st = tr.querySelector(`#st_${x.id}`);
        const delBtn = tr.querySelector(`#del_${x.id}`);

        // ---- Upload ref ----
        btn.addEventListener("click", async () => {
          try {
            st.textContent = "Şəkil yoxlanır...";
            if (!modelsReady) { st.textContent = "Model hələ yüklənir..."; return; }
            if (!fileInput.files || !fileInput.files[0]) { st.textContent = "Şəkil seçilməyib ❌"; return; }

            const file = fileInput.files[0];
            btn.disabled = true;

            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            await waitImgLoad(img);

            st.textContent = "Üz axtarılır...";

            const det = await faceapi
              .detectSingleFace(img, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
              .withFaceLandmarks()
              .withFaceDescriptor();

            if (!det) {
              st.textContent = "Üz tapılmadı ❌ başqa şəkil seç";
              btn.disabled = false;
              return;
            }

            const desc = Array.from(det.descriptor);
            st.textContent = "Serverə göndərilir...";

            const fd = new FormData();
            fd.append("ref", file);
            fd.append("descriptor", JSON.stringify(desc));

            const resp = await fetch(`/api/admin/isciler/${x.id}/ref`, {
              method: "POST",
              headers: authHeaders(),
              body: fd,
            });

            const raw = await resp.text();
            let data = {};
            try { data = JSON.parse(raw); } catch {}

            if (!resp.ok) {
              st.textContent = "Xəta: " + resp.status + " " + (data.error || raw);
              btn.disabled = false;
              return;
            }

            st.textContent = "Yadda saxlandı ✅";
            btn.disabled = false;

            const imgCell = tr.querySelector(`#img_${x.id}`);
            if (imgCell && data.ref_sekil_url) {
              imgCell.style.display = "";
              imgCell.src = data.ref_sekil_url + "?t=" + Date.now();
            } else {
              load();
            }
          } catch (err) {
            console.error(err);
            st.textContent = "Xəta: " + err.message;
            btn.disabled = false;
          }
        });

        // ---- Delete worker ----
        delBtn.addEventListener("click", async () => {
          const ok = confirm(`${x.ad} ${x.soyad} silinsin? (loglar da silinəcək)`);
          if (!ok) return;

          delBtn.disabled = true;

          const resp = await fetch(`/api/admin/isciler/${x.id}`, {
            method: "DELETE",
            headers: authHeaders(),
          });

          const raw = await resp.text();
          let data = {};
          try { data = JSON.parse(raw); } catch {}

          if (!resp.ok) {
            show(data.error || raw || "Xəta", false);
            delBtn.disabled = false;
            return;
          }

          show("Silindi ✅", true);
          load();
        });
      }
    } catch (err) {
      console.error(err);
      show("Load xətası: " + err.message, false);
    }
  }

  // Add worker
  document.getElementById("add").addEventListener("click", async () => {
    try {
      const ad = document.getElementById("ad").value.trim();
      const soyad = document.getElementById("soyad").value.trim();
      const vezife = document.getElementById("vezife").value.trim();

      if (!ad || !soyad || !vezife) return show("Ad/Soyad/Vəzifə boş ola bilməz", false);

      const r = await fetch("/api/admin/isciler", {
        method: "POST",
        headers: authHeaders({ "Content-Type": "application/json" }),
        body: JSON.stringify({ ad, soyad, vezife }),
      });

      const raw = await r.text();
      let data = {};
      try { data = JSON.parse(raw); } catch {}

      if (!r.ok) return show(data.error || raw || "Xəta", false);

      show("İşçi əlavə olundu ✅", true);
      document.getElementById("ad").value = "";
      document.getElementById("soyad").value = "";
      document.getElementById("vezife").value = "";

      load();
    } catch (err) {
      console.error(err);
      show("Xəta: " + err.message, false);
    }
  });

  load();
</script>

</body>
</html>
