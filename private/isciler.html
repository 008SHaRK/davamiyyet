<!doctype html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin - İşçilər</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f3f4f6}
    header{background:#111827;color:#fff;padding:14px 16px;position:sticky;top:0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .box{background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{padding:10px 12px;font-size:14px;border:1px solid #d1d5db;border-radius:10px}
    button{cursor:pointer;background:#111827;color:#fff;border:none}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:14px;vertical-align:middle}
    th{background:#f9fafb}
    .ok{color:#0a7b2e;font-weight:700}
    .bad{color:#b00020;font-weight:700}
    a{color:#fff;text-decoration:none}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .mini{font-size:12px;opacity:.8}
    .img{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#e5e7eb}
    .btn2{background:#374151}
    .tag{padding:3px 8px;border-radius:999px;font-size:12px;background:#eef2ff;display:inline-block}
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div>
      <b>İşçilər</b>
      <div class="mini">Referans şəkil (üz yoxlama üçün) buradan yüklənir</div>
    </div>
    <div style="display:flex;gap:10px">
      <a href="/admin" style="padding:8px 10px;background:#374151;border-radius:10px">← Loglar</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="box">
    <h3 style="margin:0 0 10px">Yeni işçi əlavə et</h3>
    <div class="row">
      <input id="ad" placeholder="Ad" />
      <input id="soyad" placeholder="Soyad" />

      <select id="vezife">
        <option value="">Vəzifə seç</option>
        <option value="kassır">kassır</option>
        <option value="satıcı">satıcı</option>
        <option value="menecer">menecer</option>
      </select>

      <button id="add" type="button">Əlavə et</button>
    </div>

    <div id="msg" style="margin-top:10px"></div>

    <h3 style="margin:16px 0 6px">Siyahı</h3>
    <div class="mini">Qaydası: hər işçiyə 1 referans şəkil yüklə. Sonra QR girişdə üz uyğunluğu yoxlanacaq.</div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Ad</th>
          <th>Soyad</th>
          <th>Vəzifə</th>
          <th>Aktiv</th>
          <th>Referans</th>
          <th>Referans yüklə</th>
          <th>Yaradıldı</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- face-api (browser) -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
  const tbody = document.getElementById("tbody");
  const msg = document.getElementById("msg");

  function show(text, ok = true) {
    msg.innerHTML = `<span class="${ok ? "ok" : "bad"}">${text}</span>`;
  }

  function fmtDate(x) {
    if (!x) return "-";
    return new Date(x).toLocaleString();
  }

  // ---------- Face models ----------
  let modelsReady = false;

  async function loadModels() {
    await faceapi.nets.ssdMobilenetv1.loadFromUri("/models");
    await faceapi.nets.faceLandmark68Net.loadFromUri("/models");
    await faceapi.nets.faceRecognitionNet.loadFromUri("/models");
    modelsReady = true;
    console.log("✅ Admin: modellər yükləndi");
  }

  function waitImgLoad(imgEl) {
    return new Promise((resolve, reject) => {
      if (imgEl.complete && imgEl.naturalWidth > 0) return resolve();
      imgEl.onload = () => resolve();
      imgEl.onerror = (e) => reject(e);
    });
  }

  window.addEventListener("load", () => {
    loadModels().catch((err) => {
      console.error(err);
      show("Model yükləmə xətası (Console-a bax)", false);
    });
  });

  // ---------- API ----------
  async function load() {
    try {
      tbody.innerHTML = "";

      const r = await fetch("/api/admin/isciler");
      if (!r.ok) {
        const t = await r.text();
        show("İşçilər yüklənmədi: " + r.status + " " + t, false);
        return;
      }

      const rows = await r.json();
      if (!Array.isArray(rows)) {
        show("Gözlənilməz cavab gəldi (Array deyil). Console-a bax.", false);
        console.log("isciler response:", rows);
        return;
      }

      for (const x of rows) {
        const tr = document.createElement("tr");

        const imgUrl = x.ref_sekil_url ? x.ref_sekil_url : (x.profil_sekil_url || "");

        tr.innerHTML = `
          <td>${x.id}</td>
          <td>${x.ad}</td>
          <td>${x.soyad}</td>
          <td>${x.vezife}</td>
          <td><span class="tag">${x.aktiv ? "aktiv" : "deaktiv"}</span></td>

          <!-- ✅ həmişə IMG var: yoxdursa gizli -->
          <td>
            <img class="img" id="img_${x.id}" src="${imgUrl || ""}" alt="ref" style="${imgUrl ? "" : "display:none"}">
          </td>

          <td>
            <input type="file" accept="image/*" id="f_${x.id}" />
            <button class="btn2" type="button" id="u_${x.id}">Yadda saxla</button>
            <div class="mini" id="st_${x.id}"></div>
          </td>

          <td>${fmtDate(x.yaradildi)}</td>
        `;

        tbody.appendChild(tr);

        const btn = tr.querySelector(`#u_${x.id}`);
        const fileInput = tr.querySelector(`#f_${x.id}`);
        const st = tr.querySelector(`#st_${x.id}`);

        btn.addEventListener("click", async () => {
          try {
            st.textContent = "1) Klik oldu...";
            console.log("CLICK upload", x.id);

            if (!modelsReady) {
              st.textContent = "Model hələ yüklənir...";
              return;
            }

            if (!fileInput.files || !fileInput.files[0]) {
              st.textContent = "Şəkil seçilməyib ❌";
              console.log("NO FILE");
              return;
            }

            const file = fileInput.files[0];
            console.log("FILE:", file.name, file.type, file.size);

            st.textContent = "2) Şəkil oxunur...";
            btn.disabled = true;

            // şəkli img elementinə yüklə
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            await waitImgLoad(img);
            console.log("IMG LOADED", img.naturalWidth, img.naturalHeight);

            st.textContent = "3) Üz axtarılır...";

            // Üz tap (stabil)
            const det = await faceapi
              .detectSingleFace(img, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
              .withFaceLandmarks()
              .withFaceDescriptor();

            if (!det) {
              st.textContent = "Üz tapılmadı ❌ başqa şəkil seç";
              console.log("NO FACE DETECTED");
              btn.disabled = false;
              return;
            }

            const desc = Array.from(det.descriptor);
            console.log("DESC OK len=", desc.length);

            st.textContent = "4) Serverə göndərilir...";

            const fd = new FormData();
            fd.append("ref", file);
            fd.append("descriptor", JSON.stringify(desc));

            console.log("FETCH START...");
            const resp = await fetch(`/api/admin/isciler/${x.id}/ref`, {
              method: "POST",
              body: fd,
            });

            const raw = await resp.text();
            console.log("RAW RESPONSE:", resp.status, raw);

            let data = {};
            try { data = JSON.parse(raw); } catch {}

            if (!resp.ok) {
              st.textContent = "Xəta: " + resp.status + " " + (data.error || raw);
              btn.disabled = false;
              return;
            }

            st.textContent = "Yadda saxlandı ✅";
            btn.disabled = false;

            // ✅ referans şəkli dərhal göstər + yenilə (cache qır)
            const imgCell = tr.querySelector(`#img_${x.id}`);
            if (imgCell && data.ref_sekil_url) {
              imgCell.style.display = "";
              imgCell.src = data.ref_sekil_url + "?t=" + Date.now();
            } else {
              load();
            }
          } catch (err) {
            console.error(err);
            st.textContent = "Xəta: " + err.message;
            btn.disabled = false;
          }
        });
      }
    } catch (err) {
      console.error(err);
      show("Load xətası: " + err.message, false);
    }
  }

  // işçi əlavə et
  document.getElementById("add").addEventListener("click", async () => {
    try {
      const ad = document.getElementById("ad").value.trim();
      const soyad = document.getElementById("soyad").value.trim();
      const vezife = document.getElementById("vezife").value.trim();

      if (!ad || !soyad || !vezife) return show("Ad/Soyad/Vəzifə boş ola bilməz", false);

      const r = await fetch("/api/admin/isciler", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ad, soyad, vezife }),
      });

      const raw = await r.text();
      let data = {};
      try { data = JSON.parse(raw); } catch {}

      if (!r.ok) return show(data.error || raw || "Xəta", false);

      show("İşçi əlavə olundu ✅", true);
      document.getElementById("ad").value = "";
      document.getElementById("soyad").value = "";
      document.getElementById("vezife").value = "";

      load();
    } catch (err) {
      console.error(err);
      show("Xəta: " + err.message, false);
    }
  });

  load();
</script>
</body>
</html>
