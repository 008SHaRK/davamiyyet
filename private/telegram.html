<!doctype html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin - Telegram icazəli nömrələr</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <style>
    :root{
      --bg:#f3f4f6;
      --dark:#0f172a;
      --dark2:#374151;
      --border:#e5e7eb;
      --muted:#6b7280;
      --card:#ffffff;
      --blue:#2563eb;
      --danger:#b00020;
    }

    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:#111827}
    a{color:#fff;text-decoration:none}

    /* ---------------- HEADER (Desktop + Mobile) ---------------- */
    header{
      background:var(--dark);
      color:#fff;
      padding:14px 16px;
      position:sticky;
      top:0;
      z-index:10;
    }

    header .wrapTop{
      max-width:980px;
      margin:0 auto;
      padding:0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .basliq{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:220px;
    }
    .basliq b{font-size:18px;line-height:1.1}
    .basliq .mini{font-size:12px;opacity:.85;line-height:1.3}

    .menu{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .menu a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      background:var(--dark2);
      border-radius:12px;
      font-size:14px;
      line-height:1;
      white-space:nowrap;
    }

    /* Mobile header */
    @media(max-width:640px){
      header{padding:12px 12px}
      header .wrapTop{
        flex-direction:column;
        align-items:flex-start;
      }
      .menu{width:100%;justify-content:flex-start}
      .menu a{width:100%}
      .basliq b{font-size:16px}
    }

    /* ---------------- PAGE WRAP ---------------- */
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }
    @media(max-width:480px){
      .wrap{padding:12px}
    }

    .box{
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }

    h3{margin:0 0 10px}

    .mini{font-size:12px;color:var(--muted)}
    .ok{color:#0a7b2e;font-weight:700}
    .bad{color:var(--danger);font-weight:700}

    /* ---------------- FORM ---------------- */
    .form-grid{
      display:grid;
      grid-template-columns: 1fr 160px;
      gap:10px;
      align-items:center;
      margin-top:8px;
    }

    input,button{
      padding:11px 12px;
      font-size:15px;
      border:1px solid #d1d5db;
      border-radius:10px;
      outline:none;
    }

    input{background:#fff}
    button{
      cursor:pointer;
      background:var(--blue);
      color:#fff;
      border:none;
      font-weight:700;
    }
    button:disabled{opacity:.6;cursor:not-allowed}

    @media(max-width:560px){
      .form-grid{grid-template-columns:1fr}
      .form-grid button{width:100%}
    }

    /* ---------------- TABLE (Desktop) ---------------- */
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:middle}
    th{background:#f9fafb}

    .del{
      background:var(--danger);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:9px 11px;
      font-weight:700;
      cursor:pointer;
    }

    /* ---------------- MOBILE CARDS ---------------- */
    .cards{display:none;margin-top:12px}
    .card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .card-left{display:flex;flex-direction:column;gap:6px}
    .card-id{font-size:12px;color:var(--muted)}
    .card-phone{font-weight:800;font-size:15px}
    .card-right{min-width:110px;display:flex;justify-content:flex-end}

    @media(max-width:640px){
      table{display:none}
      .cards{display:flex;flex-direction:column;gap:10px}
      .del{width:100%}
      .card-right{min-width:120px}
    }
  </style>
</head>

<body>
<header>
  <div class="wrapTop">
    <div class="basliq">
      <b>Telegram icazəli nömrələr</b>
      <div class="mini">Yalnız bu siyahıdakı nömrələr /start edəndə abunə ola bilir</div>
    </div>

    <div class="menu">
      <a href="/admin">← Loglar</a>
      <a href="/admin/isciler">İşçilər</a>
      <a href="/admin/maas">Maaş</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="box">
    <h3>Yeni nömrə əlavə et</h3>

    <div class="form-grid">
      <input id="telefon" placeholder="+994501234567" />
      <button id="add" type="button">Əlavə et</button>
    </div>

    <div class="mini" style="margin-top:8px">
      Format: <b>+994...</b> (boşluq, mötərizə yazma)
    </div>

    <div id="msg" style="margin-top:10px"></div>

    <h3 style="margin:18px 0 6px">Siyahı</h3>

    <!-- Desktop table -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Telefon</th>
          <th>Sil</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <!-- Mobile cards -->
    <div id="cards" class="cards"></div>
  </div>
</div>

<script>
  const tbody = document.getElementById("tbody");
  const cards = document.getElementById("cards");
  const msg = document.getElementById("msg");
  const telefonInp = document.getElementById("telefon");
  const addBtn = document.getElementById("add");

  function show(text, ok=true){
    msg.innerHTML = `<span class="${ok ? "ok" : "bad"}">${text}</span>`;
  }

  // ✅ Basic Auth (Admin) - backend requireAdmin istifadə edir
  const ADMIN_USER = "admin";
  const ADMIN_PASS = "12345";
  const ADMIN_TOKEN = btoa(`${ADMIN_USER}:${ADMIN_PASS}`);

  function authHeaders(extra = {}) {
    return { ...extra, Authorization: `Basic ${ADMIN_TOKEN}` };
  }

  function isMobileView(){
    return window.matchMedia("(max-width: 640px)").matches;
  }

  async function load(){
    // loading UI
    tbody.innerHTML = `<tr><td colspan="3" class="mini">Yüklənir...</td></tr>`;
    cards.innerHTML = `<div class="mini">Yüklənir...</div>`;

    const r = await fetch("/api/admin/telegram/icazeli", { headers: authHeaders() });
    const rows = await r.json();

    tbody.innerHTML = "";
    cards.innerHTML = "";

    const mobile = isMobileView();

    for(const x of rows){
      if(!mobile){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${x.id}</td>
          <td>${x.telefon}</td>
          <td><button class="del" data-id="${x.id}" type="button">Sil</button></td>
        `;
        tbody.appendChild(tr);
      } else {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-left">
            <div class="card-id">ID: ${x.id}</div>
            <div class="card-phone">${x.telefon}</div>
          </div>
          <div class="card-right">
            <button class="del" data-id="${x.id}" type="button">Sil</button>
          </div>
        `;
        cards.appendChild(card);
      }
    }

    document.querySelectorAll(".del").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        if(!confirm("Bu nömrəni silmək istədiyinə əminsən?")) return;

        const resp = await fetch("/api/admin/telegram/icazeli/" + id, {
          method:"DELETE",
          headers: authHeaders(),
        });

        const raw = await resp.text();
        let data = {};
        try { data = JSON.parse(raw); } catch {}

        if(!resp.ok){
          show(data.error || raw || "Xəta", false);
          return;
        }
        show("Silindi ✅", true);
        load();
      });
    });
  }

  addBtn.addEventListener("click", async ()=>{
    const telefon = telefonInp.value.trim();
    if(!telefon) return show("Telefon boş ola bilməz", false);

    addBtn.disabled = true;

    const resp = await fetch("/api/admin/telegram/icazeli", {
      method:"POST",
      headers: authHeaders({ "Content-Type":"application/json" }),
      body: JSON.stringify({ telefon })
    });

    const raw = await resp.text();
    let data = {};
    try { data = JSON.parse(raw); } catch {}

    addBtn.disabled = false;

    if(!resp.ok){
      show(data.error || raw || "Xəta", false);
      return;
    }

    show("Əlavə olundu ✅", true);
    telefonInp.value = "";
    load();
  });

  // ekran ölçüsü dəyişəndə (telefon ↔ pc) yenilə
  window.addEventListener("resize", () => {
    clearTimeout(window.__rz);
    window.__rz = setTimeout(load, 250);
  });

  load();
</script>
</body>
</html>
