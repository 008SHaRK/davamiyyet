<!doctype html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Davamiyy…ôt Qeydiyyatƒ±</title>

  <style>
    :root{
      --bg:#eef2f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#d9e1ea;
      --brand:#0b5ed7;      /* r…ôsmi mavi */
      --brand2:#0a4fb7;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#b45309;
      --shadow: 0 10px 26px rgba(15,23,42,.10);
      --r:14px;
      --r2:12px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ---------- HEADER (r…ôsmi) ---------- */
    .header{
      background: #0b1b3a;
      color:#fff;
      border-bottom: 3px solid rgba(255,255,255,.12);
    }
    .header .wrap{
      max-width: 760px;
      margin:0 auto;
      padding: 14px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 240px;
    }
    .emblem{
      width:44px;height:44px;
      border-radius:10px;
      background: linear-gradient(180deg, #ffffff, #dbe7ff);
      display:grid;place-items:center;
      color:#0b1b3a;
      font-weight:900;
      box-shadow: 0 8px 16px rgba(0,0,0,.18);
      border: 1px solid rgba(0,0,0,.10);
      flex:0 0 auto;
    }
    .brandText b{display:block;font-size:16px;letter-spacing:.2px}
    .brandText span{display:block;font-size:12px;opacity:.85;margin-top:2px;line-height:1.3}
    .mekanPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      font-size:13px;
      white-space:nowrap;
    }
    .mekanPill b{font-size:13px}

    /* ---------- PAGE ---------- */
    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .p{ padding: 14px; }

    .titleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: #f8fafc;
    }
    .titleRow b{font-size:14px}
    .titleRow .mini{font-size:12px;color:var(--muted)}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:680px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .grid .full{ grid-column: 1 / -1; }
    }

    label{
      display:block;
      font-size:13px;
      font-weight:700;
      margin:0 0 6px;
      color:#0f172a;
    }

    input,select{
      width:100%;
      padding:12px 12px;
      border-radius: var(--r2);
      border:1px solid var(--line);
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input::placeholder{color:#94a3b8}
    input:focus,select:focus{
      border-color: rgba(11,94,215,.55);
      box-shadow: 0 0 0 4px rgba(11,94,215,.12);
    }

    select{
      padding-right:42px;
      appearance:none;
      -webkit-appearance:none;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364758b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position: right 12px center;
      background-size: 18px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.35;
    }

    /* ---------- CAMERA ---------- */
    .frame{
      position:relative;
      border-radius: 12px;
      overflow:hidden;
      border:1px solid var(--line);
      background:#000;
    }
    video, img{
      width:100%;
      display:block;
      background:#000;
      aspect-ratio: 3/4;
      object-fit:cover;
    }
    @media(min-width:680px){
      video, img{ aspect-ratio: 4/3; }
    }
    #shot{ display:none; }

    /* scanning overlay */
    .scanOverlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:none;
    }
    .scanOverlay.on{ display:block; }
    .scanShade{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.35));
    }
    .scanLine{
      position:absolute;
      left:0; right:0;
      height:2px;
      background: rgba(11,94,215,.85);
      box-shadow: 0 0 16px rgba(11,94,215,.65);
      animation: scanMove 1.5s linear infinite;
      top: 15%;
    }
    @keyframes scanMove{
      0%{ top: 18%; opacity:.35 }
      15%{ opacity:1 }
      50%{ top: 55%; opacity:1 }
      85%{ opacity:1 }
      100%{ top: 86%; opacity:.35 }
    }
    .scanText{
      position:absolute;
      left: 10px;
      bottom: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,.60);
      color:#fff;
      font-size:12px;
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
    }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    button{
      border:none;
      border-radius: 12px;
      padding: 12px 12px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      transition: filter .15s ease, transform .05s ease, opacity .2s ease;
      user-select:none;
    }
    button:active{ transform: scale(.995); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnDark{
      background:#334155;
      color:#fff;
    }
    .btnPrimary{
      background: var(--brand);
      color:#fff;
    }
    .btnPrimary:hover{ filter: brightness(.95); }
    .btnWide{
      width:100%;
      background: var(--brand2);
      color:#fff;
      margin-top:10px;
    }

    /* confirm */
    .confirm{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f8fafc;
    }
    .confirm input{ width:auto; margin-top:2px; }
    .confirm .t{
      font-size:13px;
      color:#0f172a;
      line-height:1.35;
    }
    .confirm .t span{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    /* status chips */
    .statusLine{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:#0f172a;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .dot.warn{background: var(--warn)}

    /* msg */
    .msg{
      display:none;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      margin-top:10px;
      font-size:14px;
      line-height:1.35;
    }
    .msg.ok{ display:block; border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); color:#14532d; }
    .msg.bad{ display:block; border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.08); color:#7f1d1d; }
    .msg.warn{ display:block; border-color: rgba(180,83,9,.35); background: rgba(180,83,9,.08); color:#7c2d12; }

    footer{
      text-align:center;
      color:#64748b;
      font-size:12px;
      padding: 8px 0 2px;
    }

    /* mobile: header pill a≈üaƒüƒ± d√º≈üs√ºn, da≈ümasƒ±n */
    @media(max-width:420px){
      .mekanPill{ width:100%; justify-content:flex-start; }
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="wrap">
      <div class="brand">
        <div class="emblem">AZ</div>
        <div class="brandText">
          <b>Davamiyy…ôt Qeydiyyat Sistemi</b>
          <span>≈û…ôxsiyy…ôtin doƒürulanmasƒ± √º√ß√ºn foto qeydiyyat</span>
        </div>
      </div>

      <div class="mekanPill">üìç M…ôkan: <b id="mekanTxt">-</b></div>
    </div>
  </div>

  <div class="wrap">

    <div class="card">
      <div class="titleRow">
        <b>M…ôlumatlar</b>
        <div class="mini">Ad/Soyad/V…ôzif…ô bazada nec…ôdirs…ô el…ô yaz</div>
      </div>

      <div class="p">
        <div class="grid">
          <div>
            <label>Ad</label>
            <input id="ad" placeholder="Adƒ±nƒ±z..." autocomplete="given-name" />
          </div>

          <div>
            <label>Soyad</label>
            <input id="soyad" placeholder="Soyadƒ±nƒ±z..." autocomplete="family-name" />
          </div>

          <div class="full">
            <label>V…ôzif…ô</label>
            <select id="vezife">
              <option value="">V…ôzif…ô se√ß</option>
              <option value="kassƒ±r">kassƒ±r</option>
              <option value="satƒ±cƒ±">satƒ±cƒ±</option>
              <option value="menecer">menecer</option>
            </select>
            <div class="hint">Qeyd: Yanlƒ±≈ü yazƒ±lsa sistem ‚Äúi≈ü√ßi tapƒ±lmadƒ±‚Äù qaytara bil…ôr.</div>
          </div>
        </div>

        <div class="confirm">
          <input id="chk" type="checkbox" />
          <div class="t">
            M…ôlumatlarƒ±n d√ºzg√ºnl√ºy√ºn√º t…ôsdiq edir…ôm.
            <span>Qeydiyyat zamanƒ± √ß…ôkil…ôn foto v…ô tarix/saat sistemd…ô saxlanƒ±lƒ±r.</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="titleRow">
        <b>Kamera</b>
        <div class="mini">√úz tam g√∂r√ºns√ºn, i≈üƒ±q yax≈üƒ± olsun</div>
      </div>

      <div class="p">
        <div class="frame">
          <video id="video" autoplay playsinline></video>
          <img id="shot" alt="√á…ôkil…ôn ≈ü…ôkil"/>

          <div id="scan" class="scanOverlay">
            <div class="scanShade"></div>
            <div class="scanLine"></div>
            <div class="scanText">√úz yoxlanƒ±lƒ±r‚Ä¶</div>
          </div>
        </div>

        <div class="btnRow">
          <button id="btnKamera" class="btnDark" type="button">üì∑ Kameranƒ± a√ß</button>
          <button id="btnCek" class="btnPrimary" type="button" disabled>üì∏ ≈û…ôkil √ß…ôk</button>
        </div>

        <button id="btnGonder" class="btnWide" type="button" disabled>‚úÖ G√∂nd…ôr</button>

        <div class="statusLine">
          <span class="chip"><span id="dotModel" class="dot warn"></span><span id="chipModel">Model: y√ºkl…ônir‚Ä¶</span></span>
          <span class="chip"><span id="dotFace" class="dot"></span><span id="chipFace">√úz: -</span></span>
        </div>

        <div id="mesaj" class="msg"></div>
      </div>
    </div>

    <footer>¬© 2026 MiisoftDev ‚Äì Davamiyy…ôt Platformasƒ±</footer>
  </div>

  <!-- face-api -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    const video = document.getElementById("video");
    const shot = document.getElementById("shot");
    const scan = document.getElementById("scan");

    const btnKamera = document.getElementById("btnKamera");
    const btnCek = document.getElementById("btnCek");
    const btnGonder = document.getElementById("btnGonder");
    const chk = document.getElementById("chk");
    const mesaj = document.getElementById("mesaj");

    const chipModel = document.getElementById("chipModel");
    const chipFace = document.getElementById("chipFace");
    const dotModel = document.getElementById("dotModel");
    const dotFace = document.getElementById("dotFace");

    // ‚úÖ TELEFONDA ∆èKS G√ñST∆èRƒ∞RS∆è: bunu true saxla (preview d√ºz g√∂r√ºn…ôc…ôk)
    // ∆èg…ôr s…ônd…ô t…ôsad√ºf…ôn d√ºz g√∂st…ôrs…ô, false ed…ô bil…ôrs…ôn.
    const UNMIRROR_PREVIEW = true;

    // URL-d…ôn m…ôkan: /q/corndog
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const mekan = (pathParts[0] === "q" && pathParts[1]) ? decodeURIComponent(pathParts[1]) : "unknown";
    document.getElementById("mekanTxt").innerText = mekan;

    let stream = null;
    let blobFile = null;
    let lastDescriptor = null;
    let modelsReady = false;

    function setDot(el, type){
      el.className = "dot " + (type || "");
    }

    function showMsg(text, type="ok"){
      mesaj.className = "msg " + type;
      mesaj.textContent = text;
    }

    function setScan(on, text){
      if (on) {
        scan.classList.add("on");
        const t = scan.querySelector(".scanText");
        if (t) t.textContent = text || "√úz yoxlanƒ±lƒ±r‚Ä¶";
      } else {
        scan.classList.remove("on");
      }
    }

    // Modell…ôr
    async function loadModels(){
      chipModel.textContent = "Model: y√ºkl…ônir‚Ä¶";
      setDot(dotModel, "warn");

      await faceapi.nets.ssdMobilenetv1.loadFromUri("/models");
      await faceapi.nets.faceLandmark68Net.loadFromUri("/models");
      await faceapi.nets.faceRecognitionNet.loadFromUri("/models");

      modelsReady = true;
      chipModel.textContent = "Model: hazƒ±r ‚úÖ";
      setDot(dotModel, "ok");
    }

    async function getDescriptorFromImg(imgEl){
      const det = await faceapi
        .detectSingleFace(imgEl, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!det) return null;
      return Array.from(det.descriptor);
    }

    function waitImgLoad(imgEl){
      return new Promise((resolve, reject) => {
        if (imgEl.complete && imgEl.naturalWidth > 0) return resolve();
        imgEl.onload = () => resolve();
        imgEl.onerror = (e) => reject(e);
      });
    }

    window.addEventListener("load", () => {
      loadModels().then(() => {
        showMsg("Sistem hazƒ±rdƒ±r. Kameranƒ± a√ßƒ±n.", "ok");
      }).catch(err => {
        console.error(err);
        chipModel.textContent = "Model: x…ôta ‚ùå";
        setDot(dotModel, "bad");
        showMsg("Model y√ºkl…ôm…ô x…ôtasƒ± oldu (Console-a bax)", "bad");
      });
    });

    // Checkbox ‚Üí g√∂nd…ôr aktivliyin…ô t…ôsir edir
    function refreshSendState(){
      const ok = !!chk.checked && !!blobFile && !!lastDescriptor;
      btnGonder.disabled = !ok;
    }
    chk.addEventListener("change", refreshSendState);

    // Kamera a√ß
    btnKamera.addEventListener("click", async () => {
      try {
        showMsg("Kamera a√ßƒ±lƒ±r‚Ä¶", "warn");

        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });

        video.srcObject = stream;

        // ‚úÖ PREVIEW ∆èKSƒ∞ D√úZ∆èLTDƒ∞K (CSS flip)
        video.style.transform = UNMIRROR_PREVIEW ? "scaleX(-1)" : "none";

        btnCek.disabled = false;
        showMsg("Kamera a√ßƒ±ldƒ± ‚úÖ ƒ∞ndi ≈ü…ôkil √ß…ôk…ô bil…ôrsiniz.", "ok");
      } catch (e) {
        showMsg("Kamera a√ßƒ±la bilm…ôdi: " + e.message, "bad");
      }
    });

    // ≈û…ôkil √ß…ôk
    btnCek.addEventListener("click", async () => {
      if (!stream) return;

      if (!modelsReady) {
        showMsg("Modell…ôr h…ôl…ô y√ºkl…ônir‚Ä¶ bir az g√∂zl…ôyin.", "warn");
        return;
      }

      chipFace.textContent = "√úz: yoxlanƒ±r‚Ä¶";
      setDot(dotFace, "warn");
      btnGonder.disabled = true;
      lastDescriptor = null;

      setScan(true, "Kadr hazƒ±rlanƒ±r‚Ä¶");

      const canvas = document.createElement("canvas");
      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");

      // ‚úÖ IMPORTANT:
      // CSS-l…ô videonu flip edirik, amma canvas-a t…ôsir etmir.
      // Ona g√∂r…ô burada HE√á Bƒ∞R flip ETMƒ∞Rƒ∞K.
      ctx.drawImage(video, 0, 0, w, h);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.88));
      if (!blob) {
        setScan(false);
        showMsg("≈û…ôkil alƒ±nmadƒ± ‚ùå Yenid…ôn c…ôhd edin.", "bad");
        chipFace.textContent = "√úz: -";
        setDot(dotFace, "bad");
        return;
      }

      blobFile = blob;

      // Preview g√∂st…ôr
      shot.src = URL.createObjectURL(blob);
      shot.style.display = "block";

      setScan(true, "√úz analiz edilir‚Ä¶");

      try{
        await waitImgLoad(shot);

        const desc = await getDescriptorFromImg(shot);
        if (!desc) {
          setScan(false);
          chipFace.textContent = "√úz: tapƒ±lmadƒ± ‚ùå";
          setDot(dotFace, "bad");
          showMsg("√úz tapƒ±lmadƒ±. √úz tam g√∂r√ºns√ºn, i≈üƒ±q yax≈üƒ± olsun v…ô yenid…ôn √ß…ôk.", "bad");
          lastDescriptor = null;
          refreshSendState();
          return;
        }

        lastDescriptor = desc;
        chipFace.textContent = "√úz: tapƒ±ldƒ± ‚úÖ";
        setDot(dotFace, "ok");
        setScan(false);

        showMsg("≈û…ôkil hazƒ±rdƒ±r. Checkbox se√ßin v…ô ‚ÄúG√∂nd…ôr‚Äù basƒ±n.", "ok");
        refreshSendState();

      } catch(err){
        console.error(err);
        setScan(false);
        chipFace.textContent = "√úz: x…ôta ‚ùå";
        setDot(dotFace, "bad");
        showMsg("√úz yoxlama x…ôtasƒ±: " + err.message, "bad");
        lastDescriptor = null;
        refreshSendState();
      }
    });

    // G√∂nd…ôr
    btnGonder.addEventListener("click", async () => {
      const ad = document.getElementById("ad").value.trim();
      const soyad = document.getElementById("soyad").value.trim();
      const vezife = document.getElementById("vezife").value.trim();

      if (!ad || !soyad || !vezife) {
        showMsg("Ad/Soyad/V…ôzif…ô bo≈ü ola bilm…ôz.", "bad");
        return;
      }
      if (!chk.checked) {
        showMsg("Z…ôhm…ôt olmasa t…ôsdiq edin (checkbox).", "warn");
        return;
      }
      if (!blobFile || !lastDescriptor) {
        showMsg("≈û…ôkil v…ô √ºz doƒürulanmasƒ± tamamlanmayƒ±b.", "bad");
        return;
      }

      btnGonder.disabled = true;
      setScan(true, "M…ôlumatlar g√∂nd…ôrilir‚Ä¶");
      showMsg("G√∂nd…ôrilir‚Ä¶", "warn");

      const fd = new FormData();
      fd.append("ad", ad);
      fd.append("soyad", soyad);
      fd.append("vezife", vezife);
      fd.append("mekan", mekan);
      fd.append("sekil", blobFile, "selfie.jpg");
      fd.append("descriptor", JSON.stringify(lastDescriptor));

      try {
        const r = await fetch("/api/qeydiyyat", { method: "POST", body: fd });
        const data = await r.json();

        setScan(false);

        if (!r.ok) {
          showMsg(data.error || "X…ôta oldu", "bad");
          btnGonder.disabled = false;
          return;
        }

        if (data.status === "OK") {
          showMsg(`Qeydiyyat tamamlandƒ± ‚úÖ | Hadis…ô: ${data.hadise}`, "ok");
        } else if (data.status === "LIMIT") {
          showMsg(`Limit doldu ‚ö†Ô∏è | Hadis…ô: ${data.hadise}`, "warn");
        } else {
          showMsg(`R…ôdd edildi ‚ùå | ${data.qeyd || ""}`, "bad");
        }

        // reset
        blobFile = null;
        lastDescriptor = null;
        shot.style.display = "none";
        refreshSendState();

      } catch (e) {
        setScan(false);
        showMsg("G√∂nd…ôrm…ô x…ôtasƒ±: " + e.message, "bad");
        btnGonder.disabled = false;
      }
    });
  </script>
</body>
</html>
