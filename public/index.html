<!doctype html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Davamiyy…ôt</title>

  <style>
    :root{
      --bg:#070A12;
      --bg2:#0B1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.12);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --brand:#7c3aed;
      --brand2:#06b6d4;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:var(--txt);
      padding:16px;
      background:
        radial-gradient(1100px 650px at 15% -5%, rgba(124,58,237,.40), transparent 60%),
        radial-gradient(1000px 600px at 95% 10%, rgba(6,182,212,.22), transparent 62%),
        radial-gradient(900px 520px at 60% 110%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .wrap{
      max-width:620px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:14px;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.9), rgba(6,182,212,.85));
      box-shadow: 0 12px 28px rgba(124,58,237,.25);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand b{font-size:18px; letter-spacing:.2px}
    .brand span{font-size:12px; color:var(--muted); line-height:1.35}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--txt);
      white-space:nowrap;
    }
    .pill b{font-size:12px}

    /* Cards */
    .card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .p{ padding:14px; }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    label{
      display:block;
      font-size:13px;
      font-weight:800;
      margin:0 0 6px;
      color:var(--txt);
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      font-size:16px;
      outline:none;
    }

    input::placeholder{color:rgba(229,231,235,.55)}
    input:focus, select:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 4px rgba(124,58,237,.18);
    }

    /* Premium select arrow */
    select{
      padding-right:42px;
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background-image:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23cbd5e1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat:no-repeat,no-repeat;
      background-position:left top, right 14px center;
      background-size:auto,18px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.35;
    }

    /* Camera */
    .camBox{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .frame{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--line);
      background:#000;
    }

    video, img{
      width:100%;
      display:block;
      background:#000;
    }
    video{
      aspect-ratio: 3/4;
      object-fit:cover;
    }
    img{ display:none; }

    .overlay{
      pointer-events:none;
      position:absolute;
      inset:0;
      background:
        radial-gradient(500px 400px at 50% 35%, rgba(124,58,237,.18), transparent 65%),
        radial-gradient(520px 420px at 50% 45%, rgba(6,182,212,.10), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.28));
    }

    /* face guide */
    .guide{
      pointer-events:none;
      position:absolute;
      left:50%;
      top:48%;
      transform: translate(-50%,-50%);
      width:min(70%,280px);
      aspect-ratio: 1/1.2;
      border-radius: 999px;
      border: 2px dashed rgba(255,255,255,.25);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      opacity:.9;
    }

    .btnRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    button{
      border:none;
      border-radius:16px;
      padding:13px 12px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      color:white;
      transition: transform .08s ease, opacity .2s ease, filter .2s ease;
      user-select:none;
    }
    button:active{ transform: scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnDark{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
    }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.90));
      box-shadow: 0 16px 36px rgba(124,58,237,.25);
    }

    .btnWide{
      width:100%;
      background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(6,182,212,.85));
      box-shadow: 0 16px 36px rgba(34,197,94,.18);
    }

    .msg{
      display:none;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      line-height:1.35;
      font-size:14px;
      background: rgba(0,0,0,.16);
    }
    .msg.ok{
      display:block;
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: #d1fae5;
    }
    .msg.bad{
      display:block;
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      color: #fee2e2;
    }
    .msg.warn{
      display:block;
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      color: #ffedd5;
    }

    .statusLine{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.35);
    }
    .dot.ok{ background: rgba(34,197,94,.85); }
    .dot.bad{ background: rgba(239,68,68,.85); }
    .dot.warn{ background: rgba(245,158,11,.95); }

    footer{
      text-align:center;
      color: rgba(229,231,235,.65);
      font-size:12px;
      padding:10px 0 4px;
    }

    @media (min-width:560px){
      video{ aspect-ratio: 4/3; }
      .grid{ grid-template-columns:1fr 1fr; }
      .grid .full{ grid-column:1/-1; }
      .brand b{font-size:19px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="brandRow">
          <div class="logo"></div>
          <div>
            <b>Davamiyy…ôt</b>
            <div style="margin-top:2px;font-size:12px;color:var(--muted);line-height:1.35">
              QR linkind…ôn m…ôkan avtomatik g…ôlir
            </div>
          </div>
        </div>
        <span>ƒ∞≈üƒ±qlƒ± m√ºhitd…ô dayan, √ºz ovalƒ±n i√ßind…ô olsun. Sonra ‚ÄúG√∂z√ºn√º qƒ±rp‚Äù yoxlamasƒ± g…ôl…ôc…ôk.</span>
      </div>

      <div class="pill">üìç M…ôkan: <b id="mekanTxt">-</b></div>
    </div>

    <div class="card">
      <div class="p">
        <div class="grid">
          <div>
            <label>Ad</label>
            <input id="ad" placeholder="Adƒ±nƒ±z..." autocomplete="given-name" />
          </div>

          <div>
            <label>Soyad</label>
            <input id="soyad" placeholder="Soyadƒ±nƒ±z..." autocomplete="family-name" />
          </div>

          <div class="full">
            <label>V…ôzif…ô</label>
            <select id="vezife">
              <option value="">V…ôzif…ô se√ß</option>
              <option value="kassƒ±r">kassƒ±r</option>
              <option value="satƒ±cƒ±">satƒ±cƒ±</option>
              <option value="menecer">menecer</option>
            </select>
            <div class="hint">Qeyd: Ad/Soyad/V…ôzif…ô bazada nec…ôdirs…ô el…ô yaz.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="camBox">
        <div class="frame">
          <video id="video" autoplay playsinline></video>
          <img id="shot" alt="√á…ôkil…ôn ≈ü…ôkil"/>
          <div class="overlay"></div>
          <div class="guide"></div>
        </div>

        <div class="btnRow">
          <button id="btnKamera" class="btnDark" type="button">üì∑ Kameranƒ± a√ß</button>
          <button id="btnCek" class="btnPrimary" type="button" disabled>üü¶ ≈û…ôkil √ß…ôk</button>
        </div>

        <button id="btnGonder" class="btnWide" type="button" disabled>‚úÖ G√∂nd…ôr</button>

        <div class="statusLine">
          <span class="chip"><span id="dotModel" class="dot warn"></span><span id="chipModel">Model: y√ºkl…ônir‚Ä¶</span></span>
          <span class="chip"><span id="dotFace" class="dot"></span><span id="chipFace">√úz: -</span></span>
        </div>

        <div id="mesaj" class="msg"></div>
      </div>
    </div>

    <footer>¬© 2025 MiisoftDev ‚Äì Premium Digital Studio</footer>
  </div>

  <!-- face-api -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    const video = document.getElementById("video");
    const shot = document.getElementById("shot");
    const btnKamera = document.getElementById("btnKamera");
    const btnCek = document.getElementById("btnCek");
    const btnGonder = document.getElementById("btnGonder");
    const mesaj = document.getElementById("mesaj");

    const chipModel = document.getElementById("chipModel");
    const chipFace = document.getElementById("chipFace");
    const dotModel = document.getElementById("dotModel");
    const dotFace = document.getElementById("dotFace");

    // URL-d…ôn m…ôkan: /q/corndog
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const mekan = (pathParts[0] === "q" && pathParts[1]) ? decodeURIComponent(pathParts[1]) : "unknown";
    document.getElementById("mekanTxt").innerText = mekan;

    let stream = null;
    let blobFile = null;         // ≈ü…ôkil (blob)
    let lastDescriptor = null;   // descriptor (128)
    let modelsReady = false;

    function setDot(el, type){
      el.className = "dot " + (type || "");
    }

    function showMsg(text, type="ok"){
      mesaj.className = "msg " + type;
      mesaj.textContent = text;
    }

    // ===============================
    // TEXT TO SPEECH (AZ)
    // ===============================
    function speakAZ(text){
      try{
        if (!("speechSynthesis" in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "az-AZ";
        u.rate = 1;
        u.pitch = 1;
        u.volume = 1;

        const vs = window.speechSynthesis.getVoices();
        const v =
          vs.find(x => (x.lang || "").toLowerCase().startsWith("az")) ||
          vs.find(x => (x.lang || "").toLowerCase().startsWith("tr")) ||
          vs[0];
        if (v) u.voice = v;

        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    if ("speechSynthesis" in window) {
      window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
      };
    }

    // ------------------------
    // Face-api modell…ôrini y√ºkl…ô
    // ------------------------
    async function loadModels(){
      chipModel.textContent = "Model: y√ºkl…ônir‚Ä¶";
      setDot(dotModel, "warn");

      // S…ônin serverd…ô /models var dey…ô burdan y√ºkl…ôyirik
      await faceapi.nets.ssdMobilenetv1.loadFromUri("/models");
      await faceapi.nets.faceLandmark68Net.loadFromUri("/models");
      await faceapi.nets.faceRecognitionNet.loadFromUri("/models");

      modelsReady = true;
      chipModel.textContent = "Model: hazƒ±r ‚úÖ";
      setDot(dotModel, "ok");
    }

    async function getDescriptorFromImg(imgEl){
      const det = await faceapi
        .detectSingleFace(imgEl, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!det) return null;
      return Array.from(det.descriptor);
    }

    function waitImgLoad(imgEl){
      return new Promise((resolve, reject) => {
        if (imgEl.complete && imgEl.naturalWidth > 0) return resolve();
        imgEl.onload = () => resolve();
        imgEl.onerror = (e) => reject(e);
      });
    }

    // ===============================
    // BLINK CHECK
    // ===============================
    function eyeAspectRatio(eye){
      const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
      const A = dist(eye[1], eye[5]);
      const B = dist(eye[2], eye[4]);
      const C = dist(eye[0], eye[3]);
      return (A + B) / (2.0 * C);
    }

    async function runBlinkCheck(videoEl, timeoutMs = 6000){
      showMsg("Z…ôhm…ôt olmasa g√∂z√ºn√º qƒ±rp üëÅÔ∏è", "warn");
      speakAZ("Z…ôhm…ôt olmasa g√∂z√ºn√º qƒ±rp");

      const start = Date.now();
      let closedOnce = false;

      while (Date.now() - start < timeoutMs) {
        const det = await faceapi
          .detectSingleFace(videoEl, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
          .withFaceLandmarks();

        if (!det) continue;

        const leftEye = det.landmarks.getLeftEye();
        const rightEye = det.landmarks.getRightEye();
        const ear = (eyeAspectRatio(leftEye) + eyeAspectRatio(rightEye)) / 2;

        if (ear < 0.20) closedOnce = true;
        if (closedOnce && ear > 0.26) {
          speakAZ("T…ô≈ü…ôkk√ºrl…ôr. T…ôsdiql…ôndi");
          showMsg("T…ôsdiql…ôndi ‚úÖ ƒ∞ndi ≈ü…ôkil √ß…ôkil…ô bil…ôr.", "ok");
          return true;
        }
      }

      speakAZ("G√∂z qƒ±rpma t…ôsdiql…ônm…ôdi");
      showMsg("G√∂z qƒ±rpma t…ôsdiql…ônm…ôdi ‚ùå Yenid…ôn yoxla.", "bad");
      return false;
    }

    window.addEventListener("load", () => {
      loadModels().then(() => {
        showMsg("Modell…ôr y√ºkl…ôndi ‚úÖ", "ok");
      }).catch(err => {
        console.error("Model x…ôtasƒ±:", err);
        chipModel.textContent = "Model: x…ôta ‚ùå";
        setDot(dotModel, "bad");
        showMsg("Model y√ºkl…ôm…ô x…ôtasƒ± oldu (F12 Console-a bax)", "bad");
      });
    });

    // ------------------------
    // Kamera a√ß
    // ------------------------
    btnKamera.addEventListener("click", async () => {
      try {
        speakAZ("Kamera a√ßƒ±lƒ±r");
        showMsg("Kamera a√ßƒ±lƒ±r‚Ä¶", "warn");

        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });

        video.srcObject = stream;
        btnCek.disabled = false;

        showMsg("Kamera a√ßƒ±ldƒ± ‚úÖ ƒ∞ndi ‚Äú≈û…ôkil √ß…ôk‚Äù bas.", "ok");
      } catch (e) {
        showMsg("Kamera a√ßƒ±la bilm…ôdi: " + e.message, "bad");
      }
    });

    // ------------------------
    // ≈û…ôkil √ß…ôk (√∂nc…ô blink check)
    // ------------------------
    btnCek.addEventListener("click", async () => {
      if (!stream) return;

      if (!modelsReady) {
        showMsg("Modell…ôr h…ôl…ô y√ºkl…ônir... 2 saniy…ô g√∂zl…ô.", "warn");
        return;
      }

      // blink check
      const okBlink = await runBlinkCheck(video);
      if (!okBlink) return;

      chipFace.textContent = "√úz: yoxlanƒ±r‚Ä¶";
      setDot(dotFace, "warn");
      btnGonder.disabled = true;
      lastDescriptor = null;

      const canvas = document.createElement("canvas");
      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.88));
      if (!blob) {
        showMsg("≈û…ôkil alƒ±nmadƒ± ‚ùå Yenid…ôn √ß…ôk.", "bad");
        chipFace.textContent = "√úz: -";
        setDot(dotFace, "bad");
        return;
      }

      blobFile = blob;
      shot.src = URL.createObjectURL(blob);
      shot.style.display = "block";

      showMsg("≈û…ôkil √ß…ôkildi ‚úÖ √úz axtarƒ±lƒ±r...", "ok");

      try {
        await waitImgLoad(shot);
        const desc = await getDescriptorFromImg(shot);

        if (!desc) {
          chipFace.textContent = "√úz: tapƒ±lmadƒ± ‚ùå";
          setDot(dotFace, "bad");
          showMsg("√úz tapƒ±lmadƒ± ‚ùå √úz tam g√∂r√ºns√ºn, yenid…ôn √ß…ôk.", "bad");
          speakAZ("√úz tapƒ±lmadƒ±. Yenid…ôn ≈ü…ôkil √ß…ôk");
          return;
        }

        lastDescriptor = desc;
        chipFace.textContent = "√úz: tapƒ±ldƒ± ‚úÖ";
        setDot(dotFace, "ok");
        btnGonder.disabled = false;
        showMsg("√úz tapƒ±ldƒ± ‚úÖ ƒ∞ndi g√∂nd…ôr…ô bil…ôrs…ôn.", "ok");

      } catch (err) {
        console.error(err);
        chipFace.textContent = "√úz: x…ôta ‚ùå";
        setDot(dotFace, "bad");
        showMsg("√úz yoxlama x…ôtasƒ±: " + err.message, "bad");
      }
    });

    // ------------------------
    // G√∂nd…ôr
    // ------------------------
    btnGonder.addEventListener("click", async () => {
      const ad = document.getElementById("ad").value.trim();
      const soyad = document.getElementById("soyad").value.trim();
      const vezife = document.getElementById("vezife").value.trim();

      if (!ad || !soyad || !vezife) {
        showMsg("Ad/Soyad/V…ôzif…ô bo≈ü ola bilm…ôz.", "bad");
        speakAZ("Ad, soyad v…ô v…ôzif…ô bo≈ü ola bilm…ôz");
        return;
      }
      if (!blobFile) {
        showMsg("∆èvv…ôl ≈ü…ôkil √ß…ôk.", "bad");
        speakAZ("∆èvv…ôl ≈ü…ôkil √ß…ôk");
        return;
      }
      if (!lastDescriptor) {
        showMsg("√úz tapƒ±lmadƒ±. Yenid…ôn ≈ü…ôkil √ß…ôk.", "bad");
        speakAZ("√úz tapƒ±lmadƒ±. Yenid…ôn ≈ü…ôkil √ß…ôk");
        return;
      }

      btnGonder.disabled = true;
      showMsg("G√∂nd…ôrilir... ‚è≥", "warn");
      speakAZ("G√∂nd…ôrilir");

      const fd = new FormData();
      fd.append("ad", ad);
      fd.append("soyad", soyad);
      fd.append("vezife", vezife);
      fd.append("mekan", mekan);
      fd.append("sekil", blobFile, "selfie.jpg");
      fd.append("descriptor", JSON.stringify(lastDescriptor));

      try {
        const r = await fetch("/api/qeydiyyat", { method: "POST", body: fd });
        const data = await r.json();

        if (!r.ok) {
          showMsg(data.error || "X…ôta oldu", "bad");
          speakAZ("X…ôta oldu");
          btnGonder.disabled = false;
          return;
        }

        if (data.status === "OK") {
          showMsg(`Uƒüurlu ‚úÖ | Hadis…ô: ${data.hadise}`, "ok");
          speakAZ("Uƒüurlu");
        } else if (data.status === "LIMIT") {
          showMsg(`Limit doldu ‚ö†Ô∏è | Hadis…ô: ${data.hadise}`, "warn");
          speakAZ("Limit doldu");
        } else {
          showMsg(`R…ôdd edildi ‚ùå | ${data.qeyd || ""}`, "bad");
          speakAZ("R…ôdd edildi");
        }

      } catch (e) {
        showMsg("G√∂nd…ôrm…ô x…ôtasƒ±: " + e.message, "bad");
        speakAZ("G√∂nd…ôrm…ô x…ôtasƒ±");
      } finally {
        btnGonder.disabled = false;
      }
    });
  </script>
</body>
</html>
